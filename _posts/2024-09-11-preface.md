---
layout: post
title:  "前言"
permalink: /queueing/preface/
categories: 计算机系统的性能建模与设计
---

# 前言

## 计算机系统设计中的即兴世界

计算机系统的设计常常被视为一门艺术，而非科学。诸如选择使用哪种调度策略、运行多少服务器、每台服务器运行的速度等决策，往往基于直觉而不是基于数学公式推导。某些内核中的策略是根据经验制定的，没有解释, 被“神秘常数”所左右, 但似乎对特定的benchmark有效。(*译者的理解: 计算机系统实在复杂而庞大, 没有人能完全理解从半导体到中间件到应用的整个过程, 至少我做不到, 所以很难建立一个普适的周全的模型来解决所有问题, 做实验和动手是个好习惯*). 计算机系统的学生通常被鼓励要先构建系统，然后再根据实际情况调整策略以改善性能，而不是首先建立一个正式的模型并设计系统，以确保其满足性能目标。

即使在尝试评估现有计算机系统的性能时，学生们通常被鼓励模拟系统，花费很多天时间在他们的模拟系统上运行不同的工作负载，以观察会发生什么。由于可能的工作负载和输入参数构成的搜索空间(*译者的理解: 有效工作负载的排列组合*)通常很大，因此需要进行大量的模拟才能正确覆盖整个空间。尽管如此，数学模型几乎从未被创建，我们很少对工作负载进行正式的分析。相反，我们通过一种类似于随机的方法来表征工作负载。难怪计算机系统的学生往往觉得整个性能评估和设计过程是即兴的。举个例子， 想一想Linux 内核各版本中多年来在反复试错中不断更新的资源调度机制。(*译者也举个例子, 主机的处理器拓扑结构和缓存结构每一代都在来回摇摆, 当升级到新的纳米工艺时, 设计师往往还会使用上一代的一些设计, 来获得更多的信心, 在下一代再微调那些有问题的结构.*)

## 计算机系统的分析建模

但情况不一定要是这样的！这些系统设计人员完全可以通过数学方式来建模系统，随机表征工作负载和性能目标，并通过分析推导出系统在各种工作负载和输入参数下的性能表现。分析建模和随机过程领域已有近一个世纪的历史，可以用来帮助系统设计人员节省大量的试错时间，同时改善性能。分析建模还可以与模拟结合使用，帮助引导模拟，减少需要探索的案例数量。 (译者的理解:这是科学的方法,数学模型和实验相结合的路子).

不幸的是，尽管有成百上千本关于随机过程的书籍，但几乎没有一本是专门处理计算机系统的。这些书中的例子和涵盖的内容多集中于面向人类操作的工作领域，如制造系统，或是呼叫中心的接线员，或者是拥有不同优先级任务的装配线系统。

在许多方面，制造系统中的分析方法与计算机系统并无太大不同。人类操作员和计算机服务器之间有很多相似之处：有更快的操作员和较慢的操作员（就像有更快和较慢的服务器）；人类操作员有时会生病（就像计算机服务器有时会故障）；当不需要时，人类操作员可以被派遣回家以节省成本（就像在不需要时可以关闭计算机服务器来节约能源）；启动人类操作员的成本（类似于唤醒计算机服务器的预热成本）；这一系列相似点还可以继续下去。

然而，制造系统和计算机系统之间也存在许多差异。首先，计算机系统的工作负载显示出极高的大小可变性（服务需求），其方差系数的平方通常高达 100。这与制造系统中低可变性的服务时间形成鲜明对比。其次，计算机工作负载往往是抢占式的，且共享处理器时间（Processor-Sharing）非常普遍。相比之下，大多数制造系统的工作负载是不可抢占的（最常见的是先到先服务）。因此，大多数关于随机过程的书籍讨论的都是关于处理器共享或是不可抢占的调度策略，如剩余服务时间和处理时间，这与计算机系统的核心内容非常相关。处理器共享在分析大型服务器集群时尤其重要，这些集群通常由处理器共享服务器组成，而不是先到先服务服务器。它还与涉及带宽共享的计算应用程序相关，这种情况通常发生在处理器共享风格的系统中，而不是先到先服务的次序中。

与制造系统相比，计算机系统的性能指标也可能不同（例如，电源消耗，这是计算机系统的一个重要指标，在随机过程书籍中并未提及）。封闭式循环架构，其中新任务在现有任务完成之前不会被创建，其性能目标是最大化吞吐量，这在计算机系统中很常见，但在传统排队书籍中往往被忽略。最后，计算机系统中的磁盘、网络协议、数据库、内存控制器以及其他计算机系统发生的特定类型交互，与传统排队书籍中的分析内容大相径庭。

## 本书的目标

许多次我走进一位计算机科学家的办公室时，看到他的书架上有一本排队论的书，我感到很高兴。然而，不幸的是，当我问他时，这位同事很快回答说他从来不看那本书，因为“现实世界不是M/M/1排队系统，我看不懂那章之后的任何内容。” 问题是排队论的书籍通常对计算机科学家来说并不“友好”。这些应用并不面向计算机系统，而所使用的假设对计算机系统来说常常是不现实的。此外，这些书籍抽象难懂，对于任何不熟悉高级数学的人来说更是难以理解。在某种程度上，这是难以避免的：如果不“简化”，就无法提供读者能直接应用的公式，取而代之的是，读者必须自己推导公式，而这需要掌握大量的数学知识。幸运的是，正如我最喜欢的一位作者谢尔顿·罗斯 (Sheldon Ross) 所展示的那样，可以通过有趣且简单的方式来进行随机分析，而无需首先学习测度论和实分析。

译者注: 这两个方法都距离工程实践太远了.

```
测度论（Measure Theory）和实分析（Real Analysis）是数学中的两个重要领域，通常用于研究复杂的数学问题，特别是在概率论、分析学和相关领域中。以下是对它们的简要解释：

1. 测度论（Measure Theory）
测度论是一种用于研究“大小”或“体积”的数学工具，尤其适用于描述不规则形状或无限维空间中的集合。它是概率论的基础，因为它定义了如何在复杂的空间中为事件分配概率。

核心概念：

测度（Measure）：是将集合的大小或体积赋予一个数值的规则。简单来说，它是对集合的一个广义的面积或体积的定义，能够处理不规则或无限的集合。
Lebesgue测度：是最常见的测度，它使得我们能够处理比传统几何测度（例如长度、面积）更复杂的对象。

可测集合：这是指可以定义测度的集合。

测度论在概率论、统计学和函数空间的研究中有重要应用。例如，它允许我们在概率论中定义一个随机变量的“概率分布”。

2. 实分析（Real Analysis）
实分析是分析学的一个分支，主要研究实数、函数序列和极限等基本概念。实分析是微积分的理论基础，但它更加严谨和广泛。它重点研究在实数范围内的函数行为、收敛性、连续性、微分和积分等问题。

核心概念：

极限：这是函数、序列等趋向某一值的概念，是微积分中导数和积分的基础。
连续性：研究函数在某点附近的行为，以及如何在某个点附近保持一致的变化。

微分和积分：实分析提供了微积分的理论框架，通过严谨的定义来研究函数的变化率（导数）和累积量（积分）。

Lebesgue积分：这是传统Riemann积分的扩展形式，能够处理更广泛的函数，尤其是那些在某些点上不连续的函数。

两者的关系

测度论与实分析的关系：实分析中的许多结果，尤其是关于积分和收敛性的问题，都依赖于测度论。测度论提供了更一般的积分定义（即Lebesgue积分），可以处理Riemann积分不能处理的更复杂的函数和集合。因此，测度论是现代分析学的重要工具。

应用
测度论 被广泛应用于概率论、统计学、量子物理等领域。它使我们能够定义复杂随机变量的概率分布。
实分析 是数学、物理学和工程学中的核心学科，尤其在信号处理、数据分析、微分方程和最优化等领域有重要应用。
总的来说，测度论和实分析都是用于研究数学对象的一般化、精细化的工具，在数学领域中的许多分支都有广泛的应用。
```

我写这本书的动机是通过将计算机科学家引入强大的排队理论建模和分析世界，来改进计算机系统的设计。个人而言，我发现排队论分析在我的研究中非常有价值，包括设计网络的路由协议、为Web服务器和数据库管理系统设计更好的调度算法、磁盘调度、内存条分配、计算资源调度以及数据中心的容量规划等。从内容上来看，我有两个目标：首先，我希望提供来自计算机系统的应用案例，使本书与计算机科学家相关且有趣。为此，书中约有一半章节是“应用”章节。其次，我希望让本书在数学上足够深入，使读者能够真正发展新的排队论分析，而不仅仅是应用现有的分析方法。随着计算机系统和它们的工作负载不断发展并变得越来越复杂，使用已知的排队框架和分析来建模这些系统是不现实的。作为计算机系统的设计者，我不断发现自己不得不发明新的排队概念来建模计算机系统的某些方面。

## 本书的缘起

1998年，作为麻省理工学院的一名博士后，我开发并教授了一门新的计算机科学课程，名为《计算机系统性能分析与设计》（Performance Analysis and Design of Computer Systems）。该课程的描述如下：

    在设计计算机系统时，通常会受到某些性能目标的约束（例如，低响应时间或高吞吐量或低能耗）。另一方面，人们通常面临许多选择：一个快速的磁盘，还是两个较慢的磁盘？该选用什么速度的CPU？我们应该将资金投入更多的缓冲空间还是更快的处理器？处理器应如何调度作业？迁移活跃作业是否值得？哪种路由策略效果最佳？应该如何在服务器之间平衡负载？如何更好地应对高度可变的工作负载？这些问题的答案往往并不直观。理想情况下，人们希望在投入时间和金钱建造系统之前就有这些问题的答案。本课程将向学生介绍分析随机建模，帮助系统设计者回答上述问题。

自那时起，我通过在卡内基梅隆大学计算机科学学院的10多次教学迭代进一步发展了这门课程，在那里我教授了面向博士生和高年级本科生不同版本的课程, 涵盖计算机科学、工程、数学和运筹学。2002年，卡内基梅隆大学Tepper商学院的运作管理部门将这门课程设为所有运作管理学生的必修课，课程被视为其资格要求的一部分。

随着其他教师，包括我自己的前博士生，采用了我的讲义来教授他们自己的课程，我经常被要求将这些讲义整理成书。这本书就是“版本1”的雏形。

## 本书概要

本书采用了问答式的写作风格，模仿了我在教学中使用的苏格拉底式方法。我认为，课堂“讲授”理应是一系列小型问题的组合，学生可以轻松地回答这些问题，并且可以让学生得出正确的直觉。在阅读本书时，重要的是不要在看到问题的答案前就先查看答案，而是努力自己回答问题。问题的设置旨在提醒读者去“思考”，而不仅仅是“阅读”，并提醒教师要提出问题，而不是仅仅陈述事实。

每一章的末尾都有练习题。这些练习题是本书不可或缺的一部分，不应被跳过。许多练习题用于展示计算机系统设计中的理论应用，通常通过揭示一个重要的见解来说明问题。所有练习题都与该章的内容相关，前期的练习题主要涉及相对简单的应用，后期的练习题则探索更具挑战性的问题。

本书共分为七个部分，各部分内容相互衔接：

- 第一部分 介绍了排队论，并从计算机系统设计中提供了激励性的例子，这些例子可以通过基础排队分析进行解答。本部分介绍了包括闭合和开放排队模型以及性能指标在内的基本排队术语。

- 第二部分 是概率的复习。为了使本书自成体系，我们在这些章节中加入了整个书中所需的所有概率知识。这包括常见的离散和连续随机变量的总结，它们的矩、条件期望和概率。同时还包括一些用于仿真的随机变量生成材料。最后，我们讨论了样本路径、随机变量序列的收敛性和时间平均值与整体平均值的比较。

- 第三部分 讲述了操作定律，或“估算分析”。这些是对所有表现良好的排队系统有效的非常简单的定律。特别地，它们不要求对到达过程或工作负载（如泊松到达或指数服务时间）做出任何假设。这些定律使我们能够快速了解系统行为的平均水平，并就哪些修改将带来最大的性能影响作出设计决策。整个部分提供了与高层计算机系统设计相关的应用。

- 第四部分讨论了马尔可夫链及其在计算机系统随机分析中的应用。马尔可夫链通过表示系统可能处于的所有状态空间，允许对系统进行更详细的分析。虽然第三部分中的操作定律通常使我们能够回答关于系统中平均作业数量的问题，但马尔可夫链使我们能够推导出多服务器系统中某个服务器 \(j\) 队列中恰好有 \(i\) 个作业的概率。第四部分涵盖了离散时间和连续时间的马尔可夫链。应用包括谷歌的PageRank算法、Aloha（以太网）网络协议以及有限缓冲路由器中丢包概率的分析。

- 第五部分在第四部分引入的马尔可夫链理论基础上，进一步分析更复杂的网络，包括服务器集群。我们分析了具有复杂路由规则的排队网络，其中作业可以与确定其在网络中路径的“类别”相关联（这些称为BCMP网络）。第五部分还推导出了服务器集群的容量配置定理，如“平方根人员配置规则”，该规则确定了提供特定延迟保证所需的最少服务器数量。

由于第四部分和第五部分基于马尔可夫链分析，因此在分析中必须做出某些“马尔可夫性”（无记忆性）的假设。特别是，假设作业的服务需求（大小）遵循指数分布，作业到达时间间隔也遵循指数分布。许多应用通过这些指数假设得到了合理的建模，使我们能够利用马尔可夫分析来深入了解系统性能。然而，在某些情况下，捕捉实际工作负载中的高可变性作业大小分布或相关性是非常重要的。

- 第六部分介绍了可以用高可变性分布替代这些指数分布的技术。引入了相位型分布，它允许我们通过指数分布的混合来建模几乎任何通用分布，利用我们在第四部分和第五部分对指数分布和马尔可夫链的理解。接着，开发了矩阵分析技术，用于分析具有相位型工作负载的系统中的到达过程和服务过程。引入了 \(M/G/1\) 队列，并讨论了诸如检验悖论等概念。还介绍了现实工作负载，包括长尾分布。引入了变换技术，这些技术有助于处理一般分布。最后，队列中的服务顺序从简单的先到先服务（FCFS）推广到时间共享（处理器共享）服务顺序，这在计算机系统中更为常见。应用包括：在作业大小高度可变的服务器集群中，研究资源分配（任务分配），既研究具有不可抢占工作负载的服务器集群，也研究具有时间共享服务器的Web服务器集群。还研究了单服务器和数据中心的功耗管理策略。

- 第七部分，也是本书的最后一部分，专门讨论了调度。智能调度在计算机系统中极其重要，因为它可以在不需要购买任何新硬件的情况下显著提高系统性能。调度是操作系统的核心内容，如网络中的带宽分配、磁盘、数据库、内存层次结构等。当前计算机系统领域的许多研究涉及新调度策略的设计和采用。然而，调度可能是反直觉的，即使是基本的调度策略的分析也远非简单。调度策略通常通过仿真进行评估。在向读者介绍评估调度策略的分析技术时，我们希望更多此类策略可以通过分析进行评估。

我们希望读者按顺序阅读各章节，但有以下例外：首先，标有星号（*）的任何章节或部分可以跳过，而不影响阅读的连贯性。其次，关于变换的章节（第25章）被故意放在了最后，因此整本书并不依赖于变换分析的知识。然而，由于学习变换分析需要一些时间，我们建议计划讲授变换的教师从课程开始时逐步引入这一主题。为此，我们在第25章末尾包含了大量的练习，这些练习不依赖于后续章节的内容，可以在课程初期安排给学生练习操作变换。

最后，我们强烈建议读者查看以下网站，以获取新的错误或软件：
- [勘误页面](http://www.cs.cmu.edu/~harchol/PerformanceModeling/errata.html)
- [软件页面](http://www.cs.cmu.edu/~harchol/PerformanceModeling/software.html)

请将发现的其他错误发送至 harchol@cs.cmu.edu。

[下一篇](/queueing/00part1/)
